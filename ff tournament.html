<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FF TOURNAMENT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A; /* Slate 900 */
            color: #F8FAFC; /* Slate 50 */
        }
        .bg-glass {
            background: rgba(30, 41, 59, 0.7); /* Slate 800 with 70% opacity */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(51, 65, 85, 0.5); /* Slate 700 with 50% opacity */
        }
        .bg-card {
            background-color: #1E293B;
        }
        .btn-primary {
            background-color: #2563EB; /* Blue 600 */
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #1D4ED8; /* Blue 700 */
        }
        .btn-secondary {
            background-color: #475569; /* Slate 600 */
            transition: background-color 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #334155; /* Slate 700 */
        }
        .input-field {
            background-color: #1E293B; /* Slate 800 */
            border: 1px solid #334155; /* Slate 700 */
            color: #F8FAFC;
        }
        .input-field:focus {
            outline: none;
            border-color: #2563EB;
            box-shadow: 0 0 0 2px #1E3A8A;
        }
        [v-cloak] {
            display: none;
        }
        .loader {
            border: 4px solid #334155;
            border-top: 4px solid #2563EB;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .toast.success { background-color: #16A34A; }
        .toast.error { background-color: #DC2626; }

        /* Custom Modal styles for confirmation */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: #1E293B;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
        }
    </style>
</head>

<body>
    <div id="app" v-cloak class="min-h-screen">
        <!-- Loader -->
        <div v-if="loading" class="fixed inset-0 bg-slate-900 bg-opacity-80 flex justify-center items-center z-50">
            <div class="loader"></div>
        </div>

        <!-- Toast Notification -->
        <div v-if="toast.message" :class="['toast', toast.type, { 'show': toast.show }]">
            {{ toast.message }}
        </div>

        <!-- Login Page -->
        <div v-if="!user" class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-glass rounded-xl p-8 w-full max-w-sm">
                <h2 class="text-3xl font-bold mb-6 text-center">FF TOURNAMENT</h2>
                <form @submit.prevent="login">
                    <div class="mb-4">
                        <label class="block mb-2 text-sm">Email</label>
                        <input type="email" v-model="loginForm.email" required class="w-full p-3 rounded-lg input-field" placeholder="Enter your email">
                    </div>
                    <div class="mb-6">
                        <label class="block mb-2 text-sm">Password</label>
                        <div class="relative">
                            <input :type="passwordFieldType" v-model="loginForm.password" required class="w-full p-3 rounded-lg input-field pr-10" placeholder="Enter your password">
                            <button type="button" @click="togglePasswordVisibility" class="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400 hover:text-white">
                                <svg v-if="passwordFieldType === 'password'" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                                    <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                                </svg>
                                <svg v-else xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414L5.293 7A7.962 7.962 0 004 10c0 2.26 1.42 4.195 3.425 5.176l-.707.707a1 1 0 001.414 1.414l.707-.707A7.962 7.962 0 0010 17a7.962 7.962 0 002.583-.417l2.122 2.122a1 1 0 001.414-1.414L14.707 15a7.962 7.962 0 002.293-2.707A7.962 7.962 0 0016 10c0-2.26-1.42-4.195-3.425-5.176l.707-.707a1 1 0 00-1.414-1.414L14.707 15a7.962 7.962 0 002.293-2.707A7.962 7.962 0 0016 10c0-2.26-1.42-4.195-3.425-5.176l.707-.707a1 1 0 00-1.414-1.414L5.293 7A7.962 7.962 0 004 10c0 2.26 1.42 4.195 3.425 5.176l-.707.707a1 1 0 001.414 1.414l.707-.707A7.962 7.962 0 0010 17a7.962 7.962 0 00-2.583.417L4.414 2.293z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                        <!-- Password reset feature is simulated -->
                        <div class="text-right mt-2">
                             <a href="#" @click.prevent="showToast('Password reset functionality is not available in this demo.', 'error')" class="text-blue-400 text-sm hover:underline">Forgot password?</a>
                        </div>
                    </div>
                    <button type="submit" class="w-full btn-primary text-white font-bold py-3 px-4 rounded-lg">Log In</button>
                    <!-- Simulated registration, as real OTP is not possible -->
                    <p class="text-center text-sm text-slate-400 mt-4">New user? <a href="#" @click.prevent="showToast('Registration is simulated. Please use any email and password.', 'success')" class="text-blue-400 hover:underline">Sign up here</a></p>
                </form>
            </div>
        </div>

        <!-- Main Application (User/Admin) -->
        <div v-else class="min-h-screen">
            <!-- Header -->
            <header class="bg-glass sticky top-0 z-40">
                <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                    <h1 class="text-xl font-bold">FF TOURNAMENT</h1>
                    <div class="flex items-center space-x-4">
                         <span class="text-sm font-medium hidden sm:block">User ID: {{ user.uid }}</span>
                        <button @click="logout" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Log Out</button>
                    </div>
                </div>
            </header>
            
            <main class="container mx-auto p-4">
                <!-- Admin Panel -->
                <div v-if="isAdmin">
                    <h2 class="text-2xl font-bold mb-4">Admin Dashboard</h2>
                    <div class="mb-6 border-b border-slate-700">
                        <nav class="flex space-x-4" aria-label="Tabs">
                            <button @click="adminPage = 'dashboard'" :class="['px-3 py-2 font-medium text-sm rounded-t-lg', adminPage === 'dashboard' ? 'border-b-2 border-blue-500 text-blue-400' : 'text-slate-400 hover:text-white']">Dashboard</button>
                            <button @click="adminPage = 'tournaments'" :class="['px-3 py-2 font-medium text-sm rounded-t-lg', adminPage === 'tournaments' ? 'border-b-2 border-blue-500 text-blue-400' : 'text-slate-400 hover:text-white']">Manage Tournaments</button>
                            <button @click="adminPage = 'payments'" :class="['px-3 py-2 font-medium text-sm rounded-t-lg', adminPage === 'payments' ? 'border-b-2 border-blue-500 text-blue-400' : 'text-slate-400 hover:text-white']">Manage Payments</button>
                            <button @click="adminPage = 'issues'" :class="['px-3 py-2 font-medium text-sm rounded-t-lg', adminPage === 'issues' ? 'border-b-2 border-blue-500 text-blue-400' : 'text-slate-400 hover:text-white']">Payment Issues</button>
                            <button @click="adminPage = 'withdrawals'" :class="['px-3 py-2 font-medium text-sm rounded-t-lg', adminPage === 'withdrawals' ? 'border-b-2 border-blue-500 text-blue-400' : 'text-slate-400 hover:text-white']">Withdrawal Requests</button>
                        </nav>
                    </div>

                    <!-- Admin: Dashboard -->
                    <div v-if="adminPage === 'dashboard'">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <!-- Total Users Card -->
                            <div class="bg-card p-6 rounded-lg shadow-md flex items-center space-x-4">
                                <span class="text-blue-400 text-2xl">&#128100;</span>
                                <div>
                                    <p class="text-sm text-slate-400">Total Users</p>
                                    <p class="text-2xl font-bold">{{ dashboardData.totalUsers }}</p>
                                </div>
                            </div>
                            <!-- Total Tournaments Card -->
                            <div class="bg-card p-6 rounded-lg shadow-md flex items-center space-x-4">
                                <span class="text-yellow-400 text-2xl">&#127942;</span>
                                <div>
                                    <p class="text-sm text-slate-400">Total Tournaments</p>
                                    <p class="text-2xl font-bold">{{ dashboardData.totalTournaments }}</p>
                                </div>
                            </div>
                             <!-- Prize Distributed Card -->
                            <div class="bg-card p-6 rounded-lg shadow-md flex items-center space-x-4">
                                <span class="text-green-400 text-2xl">&#128176;</span>
                                <div>
                                    <p class="text-sm text-slate-400">Prize Distributed</p>
                                    <p class="text-2xl font-bold">₹{{ dashboardData.prizeDistributed.toFixed(2) }}</p>
                                </div>
                            </div>
                            <!-- Total Revenue Card -->
                            <div class="bg-card p-6 rounded-lg shadow-md flex items-center space-x-4">
                                <span class="text-purple-400 text-2xl">&#128200;</span>
                                <div>
                                    <p class="text-sm text-slate-400">Total Revenue</p>
                                    <p class="text-2xl font-bold">₹{{ dashboardData.totalRevenue.toFixed(2) }}</p>
                                </div>
                            </div>
                        </div>
                        <button @click="openCreateModal" class="w-full btn-primary text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center space-x-2">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                            <span>Create New Tournament</span>
                        </button>
                    </div>

                    <!-- Admin: Manage Tournaments -->
                    <div v-if="adminPage === 'tournaments'">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold">Tournament List</h3>
                            <button @click="openCreateModal" class="btn-primary text-white font-bold py-2 px-4 rounded-lg">Create Tournament</button>
                        </div>
                         <div class="bg-glass rounded-lg overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead class="bg-slate-800">
                                        <tr>
                                            <th class="p-3">Image</th>
                                            <th class="p-3">Name</th>
                                            <th class="p-3">Entry Fee</th>
                                            <th class="p-3">Prize Pool</th>
                                            <th class="p-3">Status</th>
                                            <th class="p-3">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="t in tournaments" :key="t.id" class="border-t border-slate-700">
                                            <td class="p-3">
                                                <img :src="t.image || 'https://placehold.co/60x60/1E293B/F8FAFC?text=Image'" alt="Tournament Image" class="w-16 h-16 object-cover rounded">
                                            </td>
                                            <td class="p-3">{{ t.name }}</td>
                                            <td class="p-3">₹{{ t.entryFee }}</td>
                                            <td class="p-3">₹{{ t.prizePool }}</td>
                                            <td class="p-3">
                                                <span :class="{'text-green-400': t.status === 'Upcoming', 'text-yellow-400': t.status === 'Ongoing', 'text-red-400': t.status === 'Completed'}">{{ t.status }}</span>
                                            </td>
                                            <td class="p-3 space-x-2">
                                                <button @click="openEditModal(t)" class="text-blue-400 hover:text-blue-600">Edit</button>
                                                <button @click="showDeleteConfirm(t.id)" class="text-red-400 hover:text-red-600">Delete</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Admin: Manage Payments -->
                     <div v-if="adminPage === 'payments'">
                        <h3 class="text-xl font-semibold mb-4">Payment Requests</h3>
                         <div class="bg-glass rounded-lg overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                     <thead class="bg-slate-800">
                                        <tr>
                                            <th class="p-3">User Email</th>
                                            <th class="p-3">Tournament</th>
                                            <th class="p-3">Amount</th>
                                            <th class="p-3">Transaction ID</th>
                                            <th class="p-3">Status</th>
                                            <th class="p-3">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="p in payments" :key="p.id" class="border-t border-slate-700">
                                            <td class="p-3">{{ p.userEmail }}</td>
                                            <td class="p-3">{{ getTournamentName(p.tournamentId) }}</td>
                                            <td class="p-3">₹{{ p.amount }}</td>
                                            <td class="p-3">{{ p.transactionId }}</td>
                                            <td class="p-3">
                                                <span :class="{'text-yellow-400': p.status === 'pending', 'text-green-400': p.status === 'approved', 'text-red-400': p.status === 'rejected'}">{{ p.status }}</span>
                                            </td>
                                            <td class="p-3 space-x-2" v-if="p.status === 'pending'">
                                                <button @click="updatePaymentStatus(p.id, 'approved', p.userId, p.amount)" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs">Approve</button>
                                                <button @click="updatePaymentStatus(p.id, 'rejected', p.userId, p.amount)" class="bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-xs">Reject</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Admin: Manage Payment Issues -->
                    <div v-if="adminPage === 'issues'">
                        <h3 class="text-xl font-semibold mb-4">Reported Payment Issues</h3>
                         <div class="bg-glass rounded-lg overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead class="bg-slate-800">
                                        <tr>
                                            <th class="p-3">User Email</th>
                                            <th class="p-3">Tournament</th>
                                            <th class="p-3">Transaction ID</th>
                                            <th class="p-3">Description</th>
                                            <th class="p-3">Status</th>
                                            <th class="p-3">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="issue in issues" :key="issue.id" class="border-t border-slate-700">
                                            <td class="p-3">{{ issue.userEmail }}</td>
                                            <td class="p-3">{{ getTournamentName(issue.tournamentId) }}</td>
                                            <td class="p-3">{{ issue.transactionId }}</td>
                                            <td class="p-3 max-w-xs">{{ issue.description }}</td>
                                            <td class="p-3">
                                                <span :class="{'text-yellow-400': issue.status === 'pending', 'text-green-400': issue.status === 'resolved'}">{{ issue.status }}</span>
                                            </td>
                                            <td class="p-3" v-if="issue.status === 'pending'">
                                                <button @click="resolveIssue(issue.id)" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs">Resolved</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Admin: Withdrawal Requests -->
                    <div v-if="adminPage === 'withdrawals'">
                        <h3 class="text-xl font-semibold mb-4">Withdrawal Requests</h3>
                         <div class="bg-glass rounded-lg overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead class="bg-slate-800">
                                        <tr>
                                            <th class="p-3">User ID</th>
                                            <th class="p-3">Amount</th>
                                            <th class="p-3">UPI ID</th>
                                            <th class="p-3">Phone</th>
                                            <th class="p-3">Status</th>
                                            <th class="p-3">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="w in withdrawals" :key="w.id" class="border-t border-slate-700">
                                            <td class="p-3">{{ w.userId }}</td>
                                            <td class="p-3">₹{{ w.amount }}</td>
                                            <td class="p-3">{{ w.upiId }}</td>
                                            <td class="p-3">{{ w.phone }}</td>
                                            <td class="p-3">
                                                <span :class="{'text-yellow-400': w.status === 'pending', 'text-green-400': w.status === 'approved'}">{{ w.status }}</span>
                                            </td>
                                            <td class="p-3" v-if="w.status === 'pending'">
                                                <button @click="approveWithdrawal(w.id)" class="bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs">Approve</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- User Panel -->
                <div v-else>
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">Available Tournaments</h2>
                        <div class="flex space-x-2">
                             <button @click="showReportIssueModal = true" class="btn-secondary text-sm py-2 px-4 rounded-lg">Report Payment Issue</button>
                            <button @click="showWalletModal = true" class="btn-primary text-sm py-2 px-4 rounded-lg">My Wallet</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div v-for="t in tournaments.filter(t => t.status !== 'Completed')" :key="t.id" class="bg-glass rounded-xl overflow-hidden shadow-lg transform hover:-translate-y-1 transition-transform duration-300">
                             <img :src="t.image || 'https://placehold.co/600x400/1E293B/F8FAFC?text=Tournament+Image'" alt="Tournament Image" class="w-full h-48 object-cover">
                             <div class="p-6">
                                <div class="flex justify-between items-center mb-2">
                                    <h3 class="text-lg font-bold">{{ t.name }}</h3>
                                    <span class="px-3 py-1 text-xs font-semibold rounded-full" :class="{ 'bg-green-500/20 text-green-400': t.status === 'Upcoming', 'bg-yellow-500/20 text-yellow-400': t.status === 'Ongoing' }">{{ t.status }}</span>
                                </div>
                                <p class="text-sm text-slate-400">Entry Time: {{ new Date(t.entryTime).toLocaleString() }}</p>
                                <p class="text-sm text-slate-400 mb-4">Match Starting Time: {{ new Date(t.matchStartingTime).toLocaleString() }}</p>
                                <div class="flex justify-between items-center mb-4 text-sm">
                                    <div class="text-center">
                                        <p class="text-slate-400">Prize Pool</p>
                                        <p class="font-semibold text-lg">₹{{ t.prizePool }}</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-slate-400">Entry Fee</p>
                                        <p class="font-semibold text-lg">₹{{ t.entryFee }}</p>
                                    </div>
                                </div>
                                <div v-if="userHasPendingPayment(t.id)" class="w-full text-center text-yellow-400 p-2 rounded-lg bg-yellow-400/10">Payment Pending</div>
                                <button v-else @click="joinTournament(t)" :disabled="userHasPendingPayment(t.id)" class="w-full btn-primary text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">Join Now</button>
                                <button @click="addWinning(t)" v-if="t.status !== 'Completed'" class="w-full btn-secondary text-white font-bold py-2 px-4 rounded-lg mt-2">Simulate Win</button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
        
        <!-- Confirmation Modal -->
        <div v-if="confirmModal.show" class="modal">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">{{ confirmModal.title }}</h3>
                <p class="text-slate-300 mb-6">{{ confirmModal.message }}</p>
                <div class="flex justify-end space-x-4">
                    <button @click="confirmModal.show = false" class="btn-secondary py-2 px-4 rounded-lg">Cancel</button>
                    <button @click="confirmModal.onConfirm()" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg">Confirm</button>
                </div>
            </div>
        </div>

        <!-- Tournament Create/Edit Modal -->
        <div v-if="showTournamentModal" class="fixed inset-0 bg-slate-900 bg-opacity-80 flex justify-center items-center z-50 p-4">
            <div class="bg-slate-800 p-8 rounded-lg w-full max-w-lg">
                <h3 class="text-xl font-bold mb-6">{{ isEditing ? 'Edit Tournament' : 'Create New Tournament' }}</h3>
                <form @submit.prevent="saveTournament">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="col-span-2">
                            <label class="block mb-2 text-sm">Name</label>
                            <input type="text" v-model="currentTournament.name" required class="w-full p-2 rounded input-field">
                        </div>
                        <div class="col-span-2">
                             <label class="block mb-2 text-sm">Tournament Image URL</label>
                             <input type="url" v-model="currentTournament.image" class="w-full p-2 rounded input-field" placeholder="Enter image URL">
                        </div>
                        <div>
                            <label class="block mb-2 text-sm">Entry Fee (₹)</label>
                            <input type="number" v-model.number="currentTournament.entryFee" required class="w-full p-2 rounded input-field">
                        </div>
                        <div>
                            <label class="block mb-2 text-sm">Prize Pool (₹)</label>
                            <input type="number" v-model.number="currentTournament.prizePool" required class="w-full p-2 rounded input-field">
                        </div>
                         <div class="col-span-2">
                            <label class="block mb-2 text-sm">Entry Time</label>
                            <input type="datetime-local" v-model="currentTournament.entryTime" required class="w-full p-2 rounded input-field">
                        </div>
                        <div class="col-span-2">
                             <label class="block mb-2 text-sm">Match Starting Time</label>
                             <input type="datetime-local" v-model="currentTournament.matchStartingTime" required class="w-full p-2 rounded input-field">
                        </div>
                        <div v-if="isEditing" class="col-span-2">
                            <label class="block mb-2 text-sm">Status</label>
                            <select v-model="currentTournament.status" required class="w-full p-2 rounded input-field">
                                <option>Upcoming</option>
                                <option>Ongoing</option>
                                <option>Completed</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" @click="closeModal" class="btn-secondary py-2 px-4 rounded-lg">Cancel</button>
                        <button type="submit" class="btn-primary py-2 px-4 rounded-lg">{{ isEditing ? 'Save Changes' : 'Create' }}</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Join Tournament / Payment Modal -->
        <div v-if="selectedTournament" class="fixed inset-0 bg-slate-900 bg-opacity-80 flex justify-center items-center z-50 p-4">
            <div class="bg-slate-800 p-8 rounded-lg w-full max-w-md">
                 <h3 class="text-xl font-bold mb-2">Join "{{ selectedTournament.name }}"</h3>
                <p class="text-slate-400 mb-6">Entry Fee: ₹{{ selectedTournament.entryFee }}</p>

                <div class="mb-4 bg-slate-900 p-4 rounded-lg">
                    <p class="text-sm">Please send the payment to the UPI ID below and enter the transaction ID.</p>
                    <div class="flex flex-col items-center justify-center my-4">
                        <img src="https://placehold.co/200x200/1E293B/F8FAFC?text=QR+Code" alt="UPI QR Code" class="w-48 h-48 rounded-lg">
                    </div>
                    <p class="text-lg font-mono text-center my-2 text-green-400">bossrockingyt@okaxis</p>
                </div>
                
                <form @submit.prevent="submitPayment">
                     <div>
                        <label class="block mb-2 text-sm">Transaction ID</label>
                        <input type="text" v-model="paymentForm.transactionId" required class="w-full p-2 rounded-lg input-field" placeholder="Enter 12-digit UPI transaction ID">
                    </div>
                     <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" @click="selectedTournament = null" class="btn-secondary py-2 px-4 rounded-lg">Cancel</button>
                        <button type="submit" class="btn-primary py-2 px-4 rounded-lg">Submit Payment</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Report Issue Modal -->
        <div v-if="showReportIssueModal" class="fixed inset-0 bg-slate-900 bg-opacity-80 flex justify-center items-center z-50 p-4">
             <div class="bg-slate-800 p-8 rounded-lg w-full max-w-md">
                 <h3 class="text-xl font-bold mb-6">Report Payment Issue</h3>
                 <form @submit.prevent="submitIssue">
                    <div class="mb-4">
                        <label class="block mb-2 text-sm">Tournament</label>
                        <select v-model="issueForm.tournamentId" required class="w-full p-2 rounded-lg input-field">
                            <option value="">Select a tournament</option>
                            <option v-for="t in tournaments" :key="t.id" :value="t.id">{{ t.name }}</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block mb-2 text-sm">Transaction ID</label>
                        <input type="text" v-model="issueForm.transactionId" required class="w-full p-2 rounded-lg input-field">
                    </div>
                    <div class="mb-4">
                        <label class="block mb-2 text-sm">Description of Issue</label>
                        <textarea v-model="issueForm.description" required rows="4" class="w-full p-2 rounded-lg input-field"></textarea>
                    </div>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" @click="showReportIssueModal = false" class="btn-secondary py-2 px-4 rounded-lg">Cancel</button>
                        <button type="submit" class="btn-primary py-2 px-4 rounded-lg">Submit Issue</button>
                    </div>
                 </form>
             </div>
        </div>

        <!-- My Wallet Modal -->
        <div v-if="showWalletModal" class="fixed inset-0 bg-slate-900 bg-opacity-80 flex justify-center items-center z-50 p-4">
            <div class="bg-slate-800 p-8 rounded-lg w-full max-w-md">
                <h3 class="text-xl font-bold mb-6">My Wallet</h3>
                <div class="text-center mb-6">
                    <p class="text-slate-400">Current Balance</p>
                    <p class="text-4xl font-bold text-green-400">₹{{ userWallet.toFixed(2) }}</p>
                </div>
                <button @click="openWithdrawModal" :disabled="userWallet <= 0" class="w-full btn-primary py-3 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">Withdraw Funds</button>
                <button @click="showWalletModal = false" class="w-full btn-secondary mt-4 py-3 px-4 rounded-lg">Close</button>
            </div>
        </div>

        <!-- Withdraw Modal -->
        <div v-if="showWithdrawModal" class="fixed inset-0 bg-slate-900 bg-opacity-80 flex justify-center items-center z-50 p-4">
            <div class="bg-slate-800 p-8 rounded-lg w-full max-w-md">
                <h3 class="text-xl font-bold mb-6">Withdraw Funds</h3>
                <form @submit.prevent="submitWithdrawal">
                    <div class="mb-4">
                        <label class="block mb-2 text-sm">UPI ID</label>
                        <input type="text" v-model="withdrawalForm.upiId" required class="w-full p-2 rounded-lg input-field">
                    </div>
                    <div class="mb-4">
                        <label class="block mb-2 text-sm">Phone Number</label>
                        <input type="tel" v-model="withdrawalForm.phone" required class="w-full p-2 rounded-lg input-field">
                    </div>
                    <div class="mb-4">
                         <label class="block mb-2 text-sm">Withdrawal Amount (₹)</label>
                         <input type="number" v-model.number="withdrawalForm.amount" :max="userWallet" required class="w-full p-2 rounded-lg input-field">
                    </div>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" @click="showWithdrawModal = false" class="btn-secondary py-2 px-4 rounded-lg">Cancel</button>
                        <button type="submit" class="btn-primary py-2 px-4 rounded-lg">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { createApp, ref, onMounted } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, query, onSnapshot, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        
        // Enable debug logging for Firebase
        setLogLevel('debug');

        createApp({
            setup() {
                const loading = ref(true);
                const user = ref(null);
                const isAdmin = ref(false);
                const adminPage = ref('dashboard');
                const loginForm = ref({ email: '', password: '' });
                const userWallet = ref(0);
                const passwordFieldType = ref('password');

                const tournaments = ref([]);
                const payments = ref([]);
                const issues = ref([]);
                const users = ref([]);
                const withdrawals = ref([]);
                
                const dashboardData = ref({
                    totalUsers: 0,
                    totalTournaments: 0,
                    prizeDistributed: 0,
                    totalRevenue: 0
                });

                const showTournamentModal = ref(false);
                const isEditing = ref(false);
                const currentTournament = ref({
                    name: '',
                    image: '',
                    entryFee: 50,
                    prizePool: 500,
                    entryTime: '',
                    matchStartingTime: '',
                    status: 'Upcoming'
                });

                const selectedTournament = ref(null);
                const paymentForm = ref({ transactionId: '' });
                
                const showReportIssueModal = ref(false);
                const issueForm = ref({
                    tournamentId: '',
                    transactionId: '',
                    description: ''
                });

                const showWalletModal = ref(false);
                const showWithdrawModal = ref(false);
                const withdrawalForm = ref({ upiId: '', phone: '', amount: 0 });

                const confirmModal = ref({
                    show: false,
                    title: '',
                    message: '',
                    onConfirm: () => {}
                });

                const toast = ref({ message: '', type: 'success', show: false });

                let db, auth;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                const showToast = (message, type = 'success') => {
                    toast.value = { message, type, show: true };
                    setTimeout(() => {
                        toast.value.show = false;
                    }, 3000);
                };

                const subscribeToData = (userId) => {
                    if (!userId) {
                        console.error("User ID is null. Cannot subscribe to data.");
                        return;
                    }
                    // Subscribe to tournaments
                    onSnapshot(collection(db, `/artifacts/${appId}/public/data/tournaments`), (snapshot) => {
                        tournaments.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        dashboardData.value.totalTournaments = tournaments.value.length;
                    }, (error) => {
                        console.error("Error subscribing to tournaments:", error);
                    });

                    // Subscribe to payments
                    onSnapshot(collection(db, `/artifacts/${appId}/public/data/payments`), (snapshot) => {
                         payments.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    }, (error) => {
                        console.error("Error subscribing to payments:", error);
                    });

                    // Subscribe to issues
                    onSnapshot(collection(db, `/artifacts/${appId}/public/data/issues`), (snapshot) => {
                         issues.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    }, (error) => {
                        console.error("Error subscribing to issues:", error);
                    });

                     // Subscribe to withdrawals
                    onSnapshot(collection(db, `/artifacts/${appId}/public/data/withdrawals`), (snapshot) => {
                         withdrawals.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    }, (error) => {
                        console.error("Error subscribing to withdrawals:", error);
                    });

                    // Subscribe to users
                    onSnapshot(collection(db, `/artifacts/${appId}/public/data/users`), (snapshot) => {
                        users.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        dashboardData.value.totalUsers = users.value.length;
                    }, (error) => {
                        console.error("Error subscribing to users:", error);
                    });
                };
                
                const subscribeToUserWallet = (userId) => {
                    if (!userId) {
                        console.error("User ID is null. Cannot subscribe to user wallet.");
                        return;
                    }
                     onSnapshot(doc(db, `/artifacts/${appId}/users/${userId}/wallet/balance`), (docSnap) => {
                        if (docSnap.exists()) {
                            userWallet.value = docSnap.data().amount || 0;
                        } else {
                            userWallet.value = 0;
                        }
                    }, (error) => {
                        console.error("Error subscribing to user wallet:", error);
                    });
                };

                onMounted(async () => {
                    try {
                        const firebaseConfig = JSON.parse(__firebase_config);
                        const app = initializeApp(firebaseConfig);
                        db = getFirestore(app);
                        auth = getAuth(app);
                        
                        onAuthStateChanged(auth, async (authUser) => {
                            if (authUser) {
                                user.value = { uid: authUser.uid, email: authUser.email };
                                
                                const userRef = doc(db, `/artifacts/${appId}/public/data/users`, authUser.uid);
                                const userSnap = await getDoc(userRef);
                                if (userSnap.exists()) {
                                    user.value = { ...user.value, ...userSnap.data() };
                                    isAdmin.value = userSnap.data().isAdmin || false;
                                }
                                
                                subscribeToData(authUser.uid);
                                subscribeToUserWallet(authUser.uid);
                                showToast('Login successful!', 'success');
                            } else {
                                user.value = null;
                                isAdmin.value = false;
                            }
                            loading.value = false;
                        });
                        
                        if (typeof __initial_auth_token !== 'undefined') {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                        
                    } catch (e) {
                        console.error("Firebase initialization failed:", e);
                        loading.value = false;
                        showToast('Failed to initialize app.', 'error');
                    }
                });

                const login = async () => {
                     try {
                        loading.value = true;
                        if (loginForm.value.email === 'irfannoob609@gmail.com' && loginForm.value.password === 'Mominnoob30786.@') {
                            const userRef = doc(db, `/artifacts/${appId}/public/data/users`, 'admin-id');
                            await setDoc(userRef, { username: 'Admin', email: loginForm.value.email, isAdmin: true }, { merge: true });
                            await signInAnonymously(auth); // Use anonymous for demo
                        } else {
                             // Simulate user login/signup
                             const userRef = doc(db, `/artifacts/${appId}/public/data/users`, auth.currentUser.uid);
                             const userData = { username: `User_${Math.floor(Math.random() * 10000)}`, email: loginForm.value.email, isAdmin: false };
                             await setDoc(userRef, userData, { merge: true });
                             await signInAnonymously(auth); // Use anonymous for demo
                        }
                    } catch (e) {
                        console.error("Login failed:", e);
                        showToast('Login failed. Please try again.', 'error');
                    } finally {
                        loading.value = false;
                    }
                };

                const logout = async () => {
                     try {
                        loading.value = true;
                        await signOut(auth);
                        showToast('Logged out.', 'success');
                    } catch (e) {
                        console.error("Logout failed:", e);
                        showToast('Logout failed.', 'error');
                    } finally {
                        loading.value = false;
                    }
                };

                const closeModal = () => {
                    showTournamentModal.value = false;
                    isEditing.value = false;
                    currentTournament.value = { name: '', image: '', entryFee: 50, prizePool: 500, entryTime: '', matchStartingTime: '', status: 'Upcoming' };
                };
                
                const openCreateModal = () => {
                    isEditing.value = false;
                    currentTournament.value = { name: '', image: '', entryFee: 50, prizePool: 500, entryTime: '', matchStartingTime: '', status: 'Upcoming' };
                    showTournamentModal.value = true;
                };

                const openEditModal = (tournament) => {
                    isEditing.value = true;
                    currentTournament.value = { 
                        ...tournament, 
                        entryTime: new Date(tournament.entryTime).toISOString().slice(0, 16), 
                        matchStartingTime: new Date(tournament.matchStartingTime).toISOString().slice(0, 16) 
                    };
                    showTournamentModal.value = true;
                };

                const saveTournament = async () => {
                     try {
                        loading.value = true;
                        const newTournamentData = { 
                            ...currentTournament.value, 
                            entryTime: new Date(currentTournament.value.entryTime).toISOString(),
                            matchStartingTime: new Date(currentTournament.value.matchStartingTime).toISOString(),
                            image: currentTournament.value.image || 'https://placehold.co/600x400/1E293B/F8FAFC?text=Tournament+Image'
                        };
                        
                        if (isEditing.value) {
                             await setDoc(doc(db, `/artifacts/${appId}/public/data/tournaments`, newTournamentData.id), newTournamentData);
                             showToast('Tournament updated!', 'success');
                        } else {
                            await addDoc(collection(db, `/artifacts/${appId}/public/data/tournaments`), newTournamentData);
                            showToast('Tournament created!', 'success');
                        }
                        closeModal();
                    } catch (e) {
                         console.error("Error saving tournament:", e);
                         showToast('Failed to save tournament.', 'error');
                    } finally {
                        loading.value = false;
                    }
                };

                const showDeleteConfirm = (id) => {
                    confirmModal.value = {
                        show: true,
                        title: 'Delete Tournament?',
                        message: 'Are you sure you want to delete this tournament? This action cannot be undone.',
                        onConfirm: async () => {
                            try {
                                loading.value = true;
                                await deleteDoc(doc(db, `/artifacts/${appId}/public/data/tournaments`, id));
                                showToast('Tournament deleted.', 'success');
                            } catch (e) {
                                console.error("Error deleting tournament:", e);
                                showToast('Failed to delete tournament.', 'error');
                            } finally {
                                loading.value = false;
                                confirmModal.value.show = false;
                            }
                        }
                    };
                };
                
                const getTournamentName = (id) => {
                    const t = tournaments.value.find(t => t.id === id);
                    return t ? t.name : 'Unknown';
                };

                const updatePaymentStatus = async (id, status, userId, amount) => {
                     try {
                        loading.value = true;
                        await updateDoc(doc(db, `/artifacts/${appId}/public/data/payments`, id), { status: status });
                        if (status === 'approved') {
                            const userWalletRef = doc(db, `/artifacts/${appId}/users/${userId}/wallet/balance`);
                            const userWalletSnap = await getDoc(userWalletRef);
                            const currentBalance = userWalletSnap.exists() ? userWalletSnap.data().amount : 0;
                            await setDoc(userWalletRef, { amount: currentBalance + amount }, { merge: true });

                            // Update dashboard data (simulated)
                            dashboardData.value.totalRevenue += amount;
                        }
                        showToast(`Payment ${status}.`, 'success');
                    } catch (e) {
                         console.error("Error updating payment status:", e);
                         showToast('Failed to update payment status.', 'error');
                    } finally {
                        loading.value = false;
                    }
                };
                
                const resolveIssue = async (id) => {
                     try {
                        loading.value = true;
                        await updateDoc(doc(db, `/artifacts/${appId}/public/data/issues`, id), { status: 'resolved' });
                        showToast('Issue resolved.', 'success');
                    } catch (e) {
                        console.error("Error resolving issue:", e);
                        showToast('Failed to resolve issue.', 'error');
                    } finally {
                        loading.value = false;
                    }
                };

                const userHasPendingPayment = (tournamentId) => {
                    return payments.value.some(p => p.userId === user.value.uid && p.tournamentId === tournamentId && p.status === 'pending');
                };
                
                const joinTournament = (tournament) => {
                    selectedTournament.value = tournament;
                    paymentForm.value.transactionId = '';
                };
                
                const submitPayment = async () => {
                    if (!paymentForm.value.transactionId || !selectedTournament.value) return;
                    try {
                        loading.value = true;
                        const newPayment = {
                            userId: user.value.uid,
                            userEmail: user.value.email,
                            tournamentId: selectedTournament.value.id,
                            amount: selectedTournament.value.entryFee,
                            transactionId: paymentForm.value.transactionId,
                            status: 'pending',
                            createdAt: new Date().toISOString()
                        };
                        await addDoc(collection(db, `/artifacts/${appId}/public/data/payments`), newPayment);
                        showToast('Payment submitted for review.', 'success');
                        selectedTournament.value = null;
                    } catch (e) {
                        console.error("Error submitting payment:", e);
                        showToast('Failed to submit payment.', 'error');
                    } finally {
                        loading.value = false;
                    }
                };

                const submitIssue = async () => {
                    if (!issueForm.value.tournamentId || !issueForm.value.transactionId || !issueForm.value.description) return;
                    try {
                        loading.value = true;
                        const newIssue = {
                            userId: user.value.uid,
                            userEmail: user.value.email,
                            tournamentId: issueForm.value.tournamentId,
                            transactionId: issueForm.value.transactionId,
                            description: issueForm.value.description,
                            status: 'pending',
                            createdAt: new Date().toISOString()
                        };
                        await addDoc(collection(db, `/artifacts/${appId}/public/data/issues`), newIssue);
                        showToast('Issue successfully reported.', 'success');
                        showReportIssueModal.value = false;
                        issueForm.value = { tournamentId: '', transactionId: '', description: '' };
                    } catch (e) {
                        console.error("Error submitting issue:", e);
                        showToast('Failed to submit issue.', 'error');
                    } finally {
                        loading.value = false;
                    }
                };

                const addWinning = async (tournament) => {
                    try {
                        loading.value = true;
                        const winningAmount = tournament.prizePool;
                        const commission = winningAmount * 0.10;
                        const finalWinning = winningAmount - commission;
                        
                        const userWalletRef = doc(db, `/artifacts/${appId}/users/${user.value.uid}/wallet/balance`);
                        const userWalletSnap = await getDoc(userWalletRef);
                        const currentBalance = userWalletSnap.exists() ? userWalletSnap.data().amount : 0;
                        
                        await setDoc(userWalletRef, { amount: currentBalance + finalWinning }, { merge: true });
                        showToast(`Congratulations! You have won ₹${finalWinning.toFixed(2)} (after 10% commission deduction).`, 'success');
                    } catch (e) {
                        console.error("Error adding winning:", e);
                        showToast('Failed to add winning.', 'error');
                    } finally {
                        loading.value = false;
                    }
                };

                const openWithdrawModal = () => {
                    showWalletModal.value = false;
                    showWithdrawModal.value = true;
                    withdrawalForm.value.amount = userWallet.value;
                };

                const submitWithdrawal = async () => {
                     if (!withdrawalForm.value.upiId || !withdrawalForm.value.phone || withdrawalForm.value.amount <= 0 || withdrawalForm.value.amount > userWallet.value) {
                         showToast('Invalid information or insufficient balance.', 'error');
                         return;
                     }
                     try {
                        loading.value = true;
                        const userWalletRef = doc(db, `/artifacts/${appId}/users/${user.value.uid}/wallet/balance`);
                        const userWalletSnap = await getDoc(userWalletRef);
                        const currentBalance = userWalletSnap.exists() ? userWalletSnap.data().amount : 0;

                        if (currentBalance < withdrawalForm.value.amount) {
                            showToast('Insufficient balance.', 'error');
                            loading.value = false;
                            return;
                        }

                        // Deduct from wallet first to avoid over-withdrawal
                        await setDoc(userWalletRef, { amount: currentBalance - withdrawalForm.value.amount }, { merge: true });

                        const withdrawalRequest = {
                            userId: user.value.uid,
                            amount: withdrawalForm.value.amount,
                            upiId: withdrawalForm.value.upiId,
                            phone: withdrawalForm.value.phone,
                            status: 'pending',
                            createdAt: new Date().toISOString()
                        };
                        await addDoc(collection(db, `/artifacts/${appId}/public/data/withdrawals`), withdrawalRequest);

                        showToast('Withdrawal request submitted successfully.', 'success');
                        showWithdrawModal.value = false;
                    } catch (e) {
                        console.error("Error submitting withdrawal:", e);
                        showToast('Failed to submit withdrawal.', 'error');
                    } finally {
                        loading.value = false;
                    }
                };

                const approveWithdrawal = async (withdrawalId) => {
                     try {
                        loading.value = true;
                        await updateDoc(doc(db, `/artifacts/${appId}/public/data/withdrawals`, withdrawalId), { status: 'approved' });
                        showToast('Withdrawal approved.', 'success');
                     } catch (e) {
                        console.error("Error approving withdrawal:", e);
                        showToast('Failed to approve withdrawal.', 'error');
                     } finally {
                        loading.value = false;
                     }
                };

                const togglePasswordVisibility = () => {
                    passwordFieldType.value = passwordFieldType.value === 'password' ? 'text' : 'password';
                };

                return {
                    loading,
                    user,
                    isAdmin,
                    adminPage,
                    loginForm,
                    login,
                    logout,
                    tournaments,
                    payments,
                    issues,
                    dashboardData,
                    showTournamentModal,
                    isEditing,
                    currentTournament,
                    openCreateModal,
                    openEditModal,
                    saveTournament,
                    showDeleteConfirm,
                    getTournamentName,
                    updatePaymentStatus,
                    resolveIssue,
                    selectedTournament,
                    paymentForm,
                    joinTournament,
                    submitPayment,
                    userHasPendingPayment,
                    confirmModal,
                    toast,
                    showToast,
                    showReportIssueModal,
                    issueForm,
                    submitIssue,
                    userWallet,
                    showWalletModal,
                    addWinning,
                    showWithdrawModal,
                    withdrawalForm,
                    openWithdrawModal,
                    submitWithdrawal,
                    closeModal,
                    passwordFieldType,
                    togglePasswordVisibility,
                    withdrawals,
                    approveWithdrawal
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
